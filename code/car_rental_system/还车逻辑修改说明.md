# 租车还车逻辑修改说明

## 修改日期
2025年（本次修改）

## 修改概述

本次修改对租车还车逻辑进行了重大改进，主要包括以下几个方面：

### 1. 订单完成逻辑修改
- **修改前**：订单在到达结束日期后自动完成
- **修改后**：订单只有在用户还完车之后才完成
- **影响**：订单自动更新命令不再自动完成订单，只提醒过期订单需手动还车

### 2. 异地还车逻辑增强
- **新增功能**：
  - 还车时可以填写实际还车门店
  - 系统自动判断还车门店与取车门店是否不同
  - 如果租车时未勾选异地还车，但实际异地还车，会自动增加异地还车费用

### 3. 超时还车费用计算
- **新增功能**：
  - 如果还车时间超过预先规定的结束日期，自动计算超时费用
  - 超时费用按日租金计算（可根据业务需要调整）

## 详细修改内容

### 一、数据模型修改

#### 1. Rental模型新增字段

**文件**：`rentals/models.py`

新增字段：
- `actual_return_location` (CharField)：实际还车门店
- `overdue_fee` (DecimalField)：超时还车费用

**迁移文件**：`rentals/migrations/0004_add_return_location_fields.py`

#### 2. 模型方法更新

更新了 `calculate_order_total()` 方法，现在包含：
- 基础租金
- 押金
- 异地还车费用
- 超时还车费用

### 二、表单修改

**文件**：`rentals/forms.py`

**ReturnForm表单更新**：
- 新增 `actual_return_location` 字段（实际还车门店）
- 字段为可选，如果未填写，默认使用取车门店

### 三、视图逻辑修改

**文件**：`rentals/views.py`

#### 1. rental_return视图重构

**主要变更**：
1. **状态检查**：只有"进行中"状态的订单才能还车
2. **还车门店处理**：
   - 获取实际还车门店
   - 如果未填写，默认使用取车门店
3. **异地还车判断**：
   - 比较实际还车门店与取车门店
   - 如果不同，判断为异地还车
   - 如果租车时未勾选异地还车，但实际异地还车，增加异地还车费用（日租金的50%）
4. **超时费用计算**：
   - 如果实际还车日期超过结束日期
   - 计算超时天数
   - 按日租金计算超时费用
5. **订单完成**：
   - 更新订单状态为"已完成"
   - 检查车辆是否还有其他进行中订单
   - 如果没有，将车辆状态更新为"可用"

#### 2. calculate_rental_cost函数更新

更新费用计算函数，现在包含：
- 基础费用
- VIP折扣
- 押金
- 超时费用（overdue_fee）
- 异地还车费用（cross_location_fee）

### 四、自动更新命令修改

**文件**：`rentals/management/commands/update_expired_rentals.py`

**主要变更**：
1. **移除自动完成订单功能**：
   - 删除了 `_complete_expired_rentals()` 方法中自动完成订单的逻辑
   - 订单不再在到期后自动完成
2. **新增过期订单检查**：
   - 新增 `_check_expired_rentals()` 方法
   - 只检查并提醒过期订单，不自动完成
   - 显示过期天数和订单信息

### 五、模板修改

**文件**：`templates/rentals/rental_confirm_return.html`

**主要更新**：
1. **新增还车门店输入框**：
   - 显示取车门店信息
   - 允许输入实际还车门店
   - 如果不填写，默认使用取车门店
2. **费用预览增强**：
   - 实时计算并显示超时费用
   - 实时计算并显示异地还车费用（如果适用）
   - 区分已预约和未预约的异地还车
3. **提示信息更新**：
   - 更新了温馨提示内容
   - 说明异地还车费用规则
   - 说明超时还车费用规则

## 业务流程说明

### 还车流程

1. **选择订单**：选择状态为"进行中"的订单
2. **填写还车信息**：
   - 选择实际还车日期（不能晚于今天）
   - 填写实际还车门店（可选，默认使用取车门店）
3. **系统自动判断**：
   - 判断是否异地还车（比较还车门店与取车门店）
   - 判断是否超时（比较还车日期与结束日期）
4. **费用计算**：
   - 基础费用（已包含VIP折扣）
   - 如果未预约但实际异地还车：增加异地还车费用（日租金的50%）
   - 如果超时还车：增加超时费用（超时天数 × 日租金）
5. **完成订单**：
   - 更新订单状态为"已完成"
   - 记录实际还车日期和门店
   - 更新车辆状态为"可用"（如果没有其他进行中订单）

### 费用计算规则

1. **基础费用**：
   - 日租金 × 计划天数
   - VIP会员享受10%折扣

2. **异地还车费用**：
   - 如果租车时已预约异地还车：费用已包含在订单中
   - 如果租车时未预约但实际异地还车：费用 = 日租金 × 0.5

3. **超时还车费用**：
   - 费用 = 超时天数 × 日租金
   - 超时天数 = 实际还车日期 - 结束日期

4. **押金**：
   - 默认押金 = 日租金 × 10
   - 在订单完成后退还

## 数据库迁移

执行以下命令应用数据库迁移：

```bash
python manage.py migrate rentals
```

或者执行所有迁移：

```bash
python manage.py migrate
```

## 测试建议

### 1. 正常还车测试
- 在同门店还车
- 在计划日期内还车
- 验证订单状态和车辆状态更新

### 2. 异地还车测试
- 租车时未预约异地还车，但实际异地还车
- 验证异地还车费用是否正确计算
- 租车时已预约异地还车，实际同门店还车

### 3. 超时还车测试
- 超过计划结束日期还车
- 验证超时费用是否正确计算
- 同时超时和异地还车的组合情况

### 4. 订单自动更新测试
- 验证订单不会自动完成
- 验证过期订单只显示提醒

## 注意事项

1. **数据迁移**：
   - 执行迁移前建议备份数据库
   - 新字段有默认值，不会影响现有数据

2. **订单状态**：
   - 只有"进行中"状态的订单才能还车
   - 订单完成后不能再次还车

3. **费用计算**：
   - 异地还车费用和超时费用可以同时存在
   - 所有费用都记录在订单中，便于对账

4. **车辆状态**：
   - 只有当车辆没有其他进行中订单时，才会更新为"可用"
   - 支持一辆车同时有多个订单（时间不重叠）

## 后续优化建议

1. **费用规则可配置化**：
   - 异地还车费用比例可在系统设置中配置
   - 超时费用倍数可在系统设置中配置（如1.5倍日租金）

2. **还车门店管理**：
   - 可以添加门店管理功能
   - 下拉选择还车门店，而不是手动输入

3. **通知功能**：
   - 订单过期时自动通知客户
   - 还车后发送费用明细通知

4. **报表统计**：
   - 统计异地还车订单数量
   - 统计超时还车订单和费用

