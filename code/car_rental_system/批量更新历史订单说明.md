# 批量更新历史订单记录说明

## 功能说明

该管理命令用于批量更新历史订单记录，按照当前系统逻辑对历史数据进行统一处理：

1. **更新订单状态**：
   - 预订中 → 进行中（当到达开始日期时）
   - 进行中 → 已超时未归还（当超过结束日期时）

2. **退还退款**：
   - **已完成订单**：自动退还押金（如果订单有押金且未退还）
   - **已取消订单**：自动退还所有已支付金额（如果订单有已支付金额且未退还）

3. **刷新订单财务信息**：
   - 更新所有订单的 `amount_paid`（已支付金额）
   - 更新所有订单的 `amount_refunded`（已退款金额）
   - 更新所有订单的 `settlement_status`（结算状态）
   - 更新 `settled_at`（结算时间）

## 使用方法

### 基本用法

在项目根目录下运行：

```bash
python manage.py update_historical_orders
```

### 预览模式（推荐先执行）

在正式更新之前，建议先使用预览模式查看将要执行的操作：

```bash
python manage.py update_historical_orders --dry-run
```

预览模式不会实际修改数据，只会显示将要执行的操作。

### 选择性执行

如果只想执行部分更新，可以使用以下选项：

```bash
# 只更新订单状态
python manage.py update_historical_orders --skip-deposit --skip-financials

# 只退还押金
python manage.py update_historical_orders --skip-status --skip-financials

# 只刷新财务信息
python manage.py update_historical_orders --skip-status --skip-deposit

# 更新状态和退还押金，但不刷新财务信息
python manage.py update_historical_orders --skip-financials
```

### 命令参数说明

| 参数 | 说明 |
|------|------|
| `--dry-run` | 预览模式，不实际修改数据 |
| `--skip-status` | 跳过订单状态更新 |
| `--skip-deposit` | 跳过退款处理（包括已完成订单押金和已取消订单已支付金额） |
| `--skip-financials` | 跳过财务信息刷新 |

## 执行示例

### 预览模式示例

```bash
python manage.py update_historical_orders --dry-run
```

输出示例：
```
======================================================================
开始批量更新历史订单记录
======================================================================
当前日期: 2025-11-28
【预览模式】不会实际修改数据

[1] 更新订单状态
  发现 2 个需要激活的预订中订单...
  [预览] 订单 #123 (张三) - 将更新为"进行中"
  [预览] 订单 #124 (李四) - 将更新为"进行中"
  发现 1 个已过期的进行中订单...
  [预览] 订单 #125 (王五) - 将更新为"已超时未归还"

[2] 退还已完成订单的押金和已取消订单的已支付金额
  [预览] 订单 #100 (赵六) - 将退还押金 ¥1000.00
  [预览] 订单 #101 (钱七) - 将退还押金 ¥500.00
  [预览] 已取消订单 #102 (孙八) - 将退还已支付金额 ¥800.00

[3] 刷新订单财务信息
  刷新 50 个订单的财务信息...
  [预览] 将刷新 50 个订单的财务信息

======================================================================
批量更新完成!
======================================================================
订单状态更新: 3 个
押金退还: 2 个
财务信息刷新: 50 个
【预览模式】未实际修改数据，请移除 --dry-run 参数执行实际更新
======================================================================
```

### 正式执行示例

```bash
python manage.py update_historical_orders
```

输出示例：
```
======================================================================
开始批量更新历史订单记录
======================================================================
当前日期: 2025-11-28

[1] 更新订单状态
  发现 2 个需要激活的预订中订单...
  ✓ 订单 #123 (张三) - 状态更新为"进行中"
  ✓ 订单 #124 (李四) - 状态更新为"进行中"
  发现 1 个已过期的进行中订单...
  ✓ 订单 #125 (王五) - 状态更新为"已超时未归还"

[2] 退还已完成订单的押金和已取消订单的已支付金额
  ✓ 订单 #100 (赵六) - 退还押金 ¥1000.00
  ✓ 订单 #101 (钱七) - 退还押金 ¥500.00
  ✓ 已取消订单 #102 (孙八) - 退还已支付金额 ¥800.00

[3] 刷新订单财务信息
  刷新 50 个订单的财务信息...
  ✓ 已刷新 50 个订单的财务信息

======================================================================
批量更新完成!
======================================================================
订单状态更新: 3 个
退款处理: 3 个（包括已完成订单押金和已取消订单已支付金额）
财务信息刷新: 50 个
======================================================================
```

## 注意事项

1. **建议先预览**：在正式执行之前，强烈建议先使用 `--dry-run` 参数预览将要执行的操作。

2. **数据备份**：虽然命令使用了事务处理确保数据一致性，但执行前建议备份数据库。

3. **退款处理**：退款会创建退款记录（Payment记录），这是不可逆的操作。
   - 已完成订单：只退还押金
   - 已取消订单：退还所有已支付金额
   确保订单确实需要退款。

4. **财务信息刷新**：财务信息刷新会重新计算所有订单的支付和退款总额，确保数据准确性。

5. **执行时间**：如果订单数量很多，执行可能需要一些时间，请耐心等待。

6. **幂等性**：命令可以重复执行，不会重复更新已经处理过的数据。

## 相关文件

- 管理命令代码：`rentals/management/commands/update_historical_orders.py`
- 订单模型：`rentals/models.py`
- 支付模型：`accounts/models.py`

## 执行建议

1. **首次执行**：建议使用预览模式查看将要执行的操作
   ```bash
   python manage.py update_historical_orders --dry-run
   ```

2. **分步执行**：如果数据量很大，可以分步执行：
   ```bash
   # 第一步：只更新状态
   python manage.py update_historical_orders --skip-deposit --skip-financials
   
   # 第二步：退还押金
   python manage.py update_historical_orders --skip-status --skip-financials
   
   # 第三步：刷新财务信息
   python manage.py update_historical_orders --skip-status --skip-deposit
   ```

3. **正式执行**：确认预览无误后，执行完整更新
   ```bash
   python manage.py update_historical_orders
   ```

