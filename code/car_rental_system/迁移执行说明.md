# 数据库迁移执行说明

## 问题说明

当前系统提示有2个未应用的迁移文件：
- `vehicles/migrations/0002_add_seats_field.py` - 添加车辆座位数字段
- `rentals/migrations/0002_add_deposit_and_location_fields.py` - 添加押金和异地还车字段

如果不执行迁移，数据库中将缺少这些新字段，导致系统无法正常工作。

## 执行步骤

### 方法1：在项目目录中执行（推荐）

1. **打开终端/命令行**
   - Windows: 按 `Win + R`，输入 `cmd` 或 `powershell`
   - 或者直接在项目文件夹中，按住 `Shift` 键，右键点击空白处，选择"在此处打开 PowerShell 窗口"

2. **进入项目目录**
   ```bash
   cd code\car_rental_system
   ```

3. **执行迁移命令**
   ```bash
   python manage.py migrate
   ```

4. **查看迁移结果**
   如果成功，你会看到类似这样的输出：
   ```
   Operations to perform:
     Apply all migrations: accounts, admin, auth, contenttypes, customers, rentals, sessions, vehicles
   Running migrations:
     Applying vehicles.0002_add_seats_field... OK
     Applying rentals.0002_add_deposit_and_location_fields... OK
   ```

### 方法2：使用完整路径

如果方法1不行，可以使用完整路径：

```bash
python "E:\新建文件夹\jyymvp\zuche\zuche\code\car_rental_system\manage.py" migrate
```

### 方法3：在IDE中执行

如果你使用的是 PyCharm、VSCode 等IDE：
1. 打开终端面板
2. 确保工作目录是 `code/car_rental_system`
3. 执行 `python manage.py migrate`

## 注意事项

1. **停止开发服务器**
   - 在执行迁移前，建议先停止正在运行的 Django 开发服务器（按 `Ctrl+C`）

2. **备份数据库（可选）**
   - 如果数据库中有重要数据，建议先备份 `db.sqlite3` 文件

3. **迁移后的默认值**
   - `seats` 字段：现有车辆会自动设置为 5 座
   - `deposit` 字段：默认值为 0.00，系统会在保存订单时自动计算
   - 其他新字段都有默认值，不会影响现有数据

## 验证迁移是否成功

迁移成功后，可以：

1. **重启开发服务器**
   ```bash
   python manage.py runserver
   ```

2. **检查系统是否正常运行**
   - 访问首页，应该不再出现 "no such column" 错误
   - 在车辆管理页面，应该能看到座位数字段
   - 在租赁订单页面，应该能看到押金和异地还车相关字段

3. **查看迁移状态**
   ```bash
   python manage.py showmigrations
   ```
   所有迁移前面应该显示 `[X]` 表示已应用

## 定期运行订单状态更新（手动/计划任务）

新增的押金自动退款和订单结算逻辑并不会在迁移时常驻后台，需要通过管理命令触发：

```powershell
cd "E:\新建文件夹\jyymvp\zuche\zuche\code\car_rental_system"
.\.venv\Scripts\activate
python manage.py update_expired_rentals
```

- **手动执行**：任何时候运行上面的命令，系统都会立即把已到期的订单改为“已完成”并自动退押金。
- **建议设为计划任务**：在 Windows 任务计划程序或 Linux cron 中创建任务，让它每分钟或每天执行一次 `python manage.py update_expired_rentals`。这是自动结算、押金自动退还的唯一触发方式。

> 说明：该命令只做一次性扫描并立即结束，不会阻塞迁移或服务；把它加入计划任务即可实现“到期自动结束 + 押金自动退”的效果。

## 如果遇到问题

如果迁移执行失败，请检查：
1. Python 环境是否正确
2. Django 版本是否匹配（5.2.8）
3. 数据库文件是否有写权限
4. 是否有其他进程正在使用数据库

如有问题，请提供具体的错误信息。

