# 订单和车辆状态自动更新功能使用说明

## 功能说明

本功能实现了基于本地时间的订单和车辆状态自动更新:
- 自动将结束日期已过期的"进行中"订单更新为"已完成"
- 自动将没有进行中订单的"已租"车辆更新为"可用"

## 手动执行

在项目根目录下运行以下命令:

```bash
python manage.py update_expired_rentals
```

## 执行效果示例

```
开始执行订单状态自动更新...
当前日期: 2025-11-13

发现 8 个过期订单
  - 订单 #456: 李娜 - 京TEST02 (2025-11-10 ~ 2025-11-12)
  - 订单 #455: 张伟 - 京TEST01 (2025-11-03 ~ 2025-11-08)
  ...

✓ 已成功更新 8 个订单状态为"已完成"

开始更新车辆状态...
  - 车辆 京TEST01 仍有 1 个进行中订单,保持"已租"状态
  - 车辆 京TEST02 (测试品牌 测试型号B) 已更新为"可用"
  ...

✓ 已成功更新 3 个车辆状态为"可用"

============================================================
执行完成!
更新订单数量: 8
更新车辆数量: 3
============================================================
```

## 设置自动定时执行

### Windows 系统(任务计划程序)

1. 打开"任务计划程序"(Win + R 输入 `taskschd.msc`)

2. 点击"创建基本任务"

3. 设置任务信息:
   - 名称: 租车订单自动更新
   - 描述: 每天自动更新过期订单和车辆状态

4. 触发器设置:
   - 选择"每天"
   - 开始时间: 凌晨 01:00
   - 每隔 1 天

5. 操作设置:
   - 操作: 启动程序
   - 程序/脚本: `C:\Users\24585\Desktop\zuche\.venv\Scripts\python.exe`
   - 添加参数: `manage.py update_expired_rentals`
   - 起始于: `C:\Users\24585\Desktop\zuche\code\car_rental_system`

6. 完成创建

### Linux/Mac 系统(Cron)

编辑 crontab:
```bash
crontab -e
```

添加以下行(每天凌晨1点执行):
```bash
0 1 * * * cd /path/to/car_rental_system && /path/to/python manage.py update_expired_rentals >> /path/to/logs/auto_update.log 2>&1
```

或者每6小时执行一次:
```bash
0 */6 * * * cd /path/to/car_rental_system && /path/to/python manage.py update_expired_rentals >> /path/to/logs/auto_update.log 2>&1
```

## 更新规则

### 订单更新规则
- 条件: 状态为"进行中(ONGOING)" 且 结束日期 < 当前日期
- 操作: 将订单状态改为"已完成(COMPLETED)"
- 注意: 当天结束的订单不会被更新(使用严格小于判断)

### 车辆更新规则
- 条件: 订单状态变为"已完成"后,检查该车辆是否还有其他"进行中"的订单
- 操作: 如果没有其他进行中订单,将车辆状态从"已租(RENTED)"改为"可用(AVAILABLE)"
- 注意: 如果车辆有多个订单,需等所有订单都完成才释放车辆

## 测试功能

运行测试脚本:
```bash
python test_auto_update.py
```

该脚本会:
1. 创建测试客户、车辆和订单
2. 显示更新前的状态
3. 提示执行更新命令
4. 验证更新结果

## 注意事项

1. **日期判断**: 使用严格小于(<)判断,当天结束的订单不会被更新
   - 例如: 11月13日当天结束的订单,需要11月14日才会被更新

2. **车辆状态**: 只有当车辆没有任何"进行中"订单时,才会更新为"可用"
   - 如果车辆有多个订单,需等所有订单都完成才释放车辆

3. **幂等性**: 命令可以重复执行,不会重复更新已完成的订单

4. **数据安全**: 
   - 使用数据库事务确保数据一致性
   - 更新前会先查询确认状态
   - 建议先在测试环境验证

## 文件结构

```
rentals/
├── management/
│   ├── __init__.py
│   └── commands/
│       ├── __init__.py
│       └── update_expired_rentals.py  # 核心命令文件
```

## 技术实现

- 使用 Django Management Command 创建自定义管理命令
- 使用 ORM 查询过滤过期订单
- 使用事务确保数据一致性
- 提供详细的命令行输出信息

## 常见问题

**Q: 为什么当天结束的订单没有被更新?**
A: 这是设计如此,使用严格小于判断,允许客户在当天内归还车辆。

**Q: 车辆状态为什么没有更新为可用?**
A: 检查该车辆是否还有其他"进行中"的订单,只有当所有订单都完成后才会释放车辆。

**Q: 可以手动执行命令吗?**
A: 可以,随时运行 `python manage.py update_expired_rentals` 即可。

**Q: 执行频率建议?**
A: 建议每天执行一次(凌晨1点),也可以根据业务需求调整为每6小时或每小时执行一次。
