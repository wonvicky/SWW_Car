{% extends "base_user.html" %}
{% load static %}

{% block title %}订单支付 - 租车管理系统{% endblock %}

{% block content %}
<div class="profile-fullscreen">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-1">
                <i class="fas fa-yen-sign me-2"></i>订单支付
            </h1>
            <p class="text-muted mb-0">订单号：#{{ rental.id }}</p>
        </div>
        <a href="{% url 'accounts:order_detail' rental.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>返回订单详情
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-credit-card me-2"></i>支付信息
                    </h5>
                </div>
                <div class="card-body p-4">
                    <!-- 订单信息 -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">订单详情</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <p class="mb-1">
                                    <span class="text-muted">车辆：</span>
                                    <strong>{{ rental.vehicle.brand }} {{ rental.vehicle.model }}</strong>
                                </p>
                                <p class="mb-1">
                                    <span class="text-muted">车牌：</span>
                                    {{ rental.vehicle.license_plate }}
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1">
                                    <span class="text-muted">租赁时间：</span>
                                    {{ rental.start_date|date:"Y-m-d" }} 至 {{ rental.end_date|date:"Y-m-d" }}
                                </p>
                                <p class="mb-1">
                                    <span class="text-muted">租赁天数：</span>
                                    {{ rental.rental_days }} 天
                                </p>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- 金额信息 -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">金额明细</h6>
                        <div class="table-responsive">
                            <table class="table table-borderless">
                                <tbody>
                                    <tr>
                                        <td width="45%">基础租金（{{ rental.rental_days }} 天）：</td>
                                        <td class="text-end">¥{{ base_amount|floatformat:2 }}</td>
                                    </tr>
                                    <tr>
                                        <td>押金：</td>
                                        <td class="text-end">¥{{ deposit_amount|floatformat:2 }}</td>
                                    </tr>
                                    {% if has_cross_location_fee %}
                                    <tr>
                                        <td>异地还车费用：</td>
                                        <td class="text-end">¥{{ cross_location_fee|floatformat:2 }}</td>
                                    </tr>
                                    {% endif %}
                                    <tr class="border-top">
                                        <td><strong>应付总额（含押金）：</strong></td>
                                        <td class="text-end"><strong>¥{{ order_total_amount|floatformat:2 }}</strong></td>
                                    </tr>
                                    <tr>
                                        <td>已支付金额：</td>
                                        <td class="text-end text-success">¥{{ amount_paid|floatformat:2 }}</td>
                                    </tr>
                                    <tr>
                                        <td>已退款金额：</td>
                                        <td class="text-end text-secondary">¥{{ refunded_amount|floatformat:2 }}</td>
                                    </tr>
                                    <tr>
                                        <td>净支付（已支付 - 已退款）：</td>
                                        <td class="text-end text-primary">¥{{ net_paid|floatformat:2 }}</td>
                                    </tr>
                                    <tr class="border-top">
                                        <td><h5 class="mb-0">待支付金额：</h5></td>
                                        <td class="text-end"><h4 class="mb-0 text-primary">¥{{ remaining_amount|floatformat:2 }}</h4></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <hr>

                    <!-- 支付表单 -->
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">选择支付方式</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="{{ form.payment_method.id_for_label }}" class="form-label fw-semibold">
                                        {{ form.payment_method.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.payment_method }}
                                    {% if form.payment_method.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ form.payment_method.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- 支付方式说明 -->
                        <div class="alert alert-info">
                            <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>支付说明</h6>
                            <ul class="mb-0 small">
                                <li>当前应支付金额：<strong>¥{{ remaining_amount|floatformat:2 }}</strong></li>
                                <li>费用包含基础租金、押金{% if has_cross_location_fee %}及异地还车费用{% endif %}</li>
                                <li>押金将在订单完成并确认无误后原路退还</li>
                                <li>支付成功后，订单状态将自动更新</li>
                            </ul>
                        </div>

                        <!-- 提交按钮 -->
                        <div class="d-flex justify-content-end gap-3 mt-4 pt-3 border-top">
                            <a href="{% url 'accounts:order_detail' rental.id %}" class="btn btn-outline-secondary px-4">
                                <i class="fas fa-times me-2"></i>取消
                            </a>
                            <button type="submit" class="btn btn-success btn-lg px-5">
                                <i class="fas fa-check me-2"></i>确认支付 ¥{{ remaining_amount|floatformat:2 }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 右侧信息栏 -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>支付说明
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-3">
                            <i class="fas fa-shield-alt text-primary me-2"></i>
                            <strong>安全支付</strong>
                            <p class="small text-muted mb-0 mt-1">所有支付信息均经过加密处理，确保您的资金安全</p>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-clock text-warning me-2"></i>
                            <strong>即时到账</strong>
                            <p class="small text-muted mb-0 mt-1">支付成功后，订单状态将立即更新</p>
                        </li>
                        <li class="mb-3">
                            <i class="fas fa-receipt text-success me-2"></i>
                            <strong>支付凭证</strong>
                            <p class="small text-muted mb-0 mt-1">支付完成后可在订单详情中查看支付记录</p>
                        </li>
                        <li>
                            <i class="fas fa-headset text-info me-2"></i>
                            <strong>客服支持</strong>
                            <p class="small text-muted mb-0 mt-1">如有问题，请联系客服</p>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>支付记录
                    </h5>
                </div>
                <div class="card-body">
                    {% if recent_payments %}
                        <div class="list-group list-group-flush">
                            {% for payment in recent_payments %}
                            <div class="list-group-item px-0 py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">{{ payment.get_payment_method_display }} · {{ payment.get_transaction_type_display }}</small>
                                        <p class="mb-0 small">{{ payment.paid_at|date:"Y-m-d H:i"|default:"待处理" }}</p>
                                    </div>
                                    <div class="text-end">
                                        {% if payment.transaction_type == 'REFUND' %}
                                            <strong class="text-secondary">-¥{{ payment.amount|floatformat:2 }}</strong>
                                        {% else %}
                                            <strong class="text-success">¥{{ payment.amount|floatformat:2 }}</strong>
                                        {% endif %}
                                        <span class="badge ms-2 {% if payment.status == 'PAID' %}bg-success{% elif payment.status == 'REFUNDED' %}bg-secondary{% elif payment.status == 'FAILED' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                            {{ payment.get_status_display }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted mb-0 small text-center">暂无支付记录</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


